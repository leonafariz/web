<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Tagihan Murid</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&amp;display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    body { box-sizing: border-box; }
    * { font-family: 'Inter', sans-serif; }
    .tab-active { 
      border-bottom: 3px solid #0d9488; 
      color: #0d9488; 
      font-weight: 600;
      background: rgba(13, 148, 136, 0.1);
    }
    @media print {
      body * { visibility: hidden; }
      #print-area, #print-area * { visibility: visible; }
      #print-area { position: absolute; left: 0; top: 0; width: 100%; }
    }
    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    .animate-scale-in {
      animation: scaleIn 0.2s ease-out;
    }
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .animate-slide-in {
      animation: slideIn 0.3s ease-out;
    }
    .card-shadow {
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    }
    .card-shadow:hover {
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      transition: box-shadow 0.2s ease-in-out;
    }
    .icon-wrapper {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
    }
    .stat-card {
      background: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-end) 100%);
      border-left: 4px solid var(--border-color);
    }
    .btn-primary {
      background: linear-gradient(135deg, #0d9488 0%, #0f766e 100%);
      transition: all 0.3s ease;
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(13, 148, 136, 0.4);
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full bg-gray-50">
  <div id="app" class="w-full h-full flex flex-col overflow-hidden"><!-- Header -->
   <header class="bg-gradient-to-r from-teal-700 via-teal-600 to-teal-700 text-white shadow-xl">
    <div class="px-6 py-5 flex items-center gap-4">
     <div class="bg-white/15 backdrop-blur-sm p-3 rounded-xl shadow-lg">
      <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
      </svg>
     </div>
     <div class="flex-1">
      <h1 id="app-title" class="text-2xl font-bold tracking-tight">Sistem Informasi Tagihan Murid</h1>
      <p id="school-name" class="text-teal-100 text-sm mt-1 font-medium">SD Negeri 1 Contoh</p>
     </div>
    </div><!-- Navigation Tabs -->
    <nav class="flex gap-1 px-6 bg-teal-800/30 backdrop-blur-sm"><button onclick="switchTab('input')" id="tab-input" class="px-5 py-3 hover:bg-white/10 transition-all duration-200 tab-active flex items-center gap-2 rounded-t-lg">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
      </svg><span class="font-semibold">Input Data</span> </button> <button onclick="switchTab('tagihan')" id="tab-tagihan" class="px-5 py-3 hover:bg-white/10 transition-all duration-200 flex items-center gap-2 rounded-t-lg">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
      </svg><span class="font-semibold">Tagihan Murid</span> </button> <button onclick="switchTab('laporan')" id="tab-laporan" class="px-5 py-3 hover:bg-white/10 transition-all duration-200 flex items-center gap-2 rounded-t-lg">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
      </svg><span class="font-semibold">Laporan</span> </button> <button onclick="switchTab('pengaturan')" id="tab-pengaturan" class="px-5 py-3 hover:bg-white/10 transition-all duration-200 flex items-center gap-2 rounded-t-lg">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg><span class="font-semibold">Pengaturan</span> </button>
    </nav>
   </header><!-- Main Content -->
   <main class="flex-1 overflow-auto p-6 bg-gradient-to-br from-gray-50 to-gray-100"><!-- TAB: Input Data -->
    <div id="content-input" class="tab-content animate-slide-in">
     <div class="max-w-5xl mx-auto">
      <div class="bg-white rounded-2xl shadow-lg p-8 mb-6 border border-gray-100 card-shadow">
       <div class="flex justify-between items-center mb-6">
        <div class="flex items-center gap-3">
         <div class="bg-teal-100 p-3 rounded-xl">
          <svg class="w-6 h-6 text-teal-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
         </div>
         <h2 class="text-2xl font-bold text-gray-800">Form Input Tagihan Baru</h2>
        </div><label class="flex items-center gap-3 cursor-pointer bg-gradient-to-r from-teal-50 to-cyan-50 px-5 py-3 rounded-xl hover:from-teal-100 hover:to-cyan-100 transition-all duration-200 border border-teal-200"> <input type="checkbox" id="bulk-input-toggle" onchange="toggleBulkInput()" class="w-5 h-5 text-teal-600 rounded focus:ring-2 focus:ring-teal-500">
         <div class="flex items-center gap-2">
          <svg class="w-5 h-5 text-teal-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
          </svg><span class="text-sm font-semibold text-teal-700">Bulk Input (Multi Murid)</span>
         </div></label>
       </div>
       <form id="form-tagihan" class="space-y-5">
        <div class="grid md:grid-cols-2 gap-5">
         <div id="nama-murid-wrapper" class="md:col-span-2"><label for="nama-murid" class="block text-sm font-semibold text-gray-700 mb-2">Nama Murid</label> <input type="text" id="nama-murid" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all" placeholder="Contoh: Ahmad Subagyo"> <textarea id="nama-murid-bulk" class="hidden w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all" rows="3" placeholder="Masukkan nama murid, pisahkan dengan koma (,)
Contoh: Ahmad Subagyo, Siti Nurhaliza, Budi Santoso"></textarea>
          <p id="bulk-hint" class="hidden text-xs text-gray-500 mt-2 flex items-center gap-1">
           <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
           </svg> Pisahkan nama dengan koma (,) untuk input multiple murid sekaligus</p>
         </div>
         <div><label for="kelas" class="block text-sm font-semibold text-gray-700 mb-2">Kelas</label> <select id="kelas" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all bg-white"> <option value="">-- Pilih Kelas --</option> </select>
         </div>
         <div><label for="jenjang" class="block text-sm font-semibold text-gray-700 mb-2">Jenjang</label> <select id="jenjang" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all bg-white"> <option value="">-- Pilih Jenjang --</option> </select>
         </div>
         <div><label for="tahun-ajaran" class="block text-sm font-semibold text-gray-700 mb-2">Tahun Ajaran</label> <input type="text" id="tahun-ajaran" placeholder="Contoh: 2024/2025" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all">
         </div>
         <div><label for="jenis-tagihan" class="block text-sm font-semibold text-gray-700 mb-2">Jenis Tagihan</label> <select id="jenis-tagihan" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all bg-white"> <option value="">-- Pilih Jenis --</option> </select>
         </div>
         <div><label for="nama-tagihan" class="block text-sm font-semibold text-gray-700 mb-2">Nama Tagihan</label> <input type="text" id="nama-tagihan" placeholder="Contoh: SPP Januari, Iuran Ujian" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all">
         </div>
         <div><label for="nominal" class="block text-sm font-semibold text-gray-700 mb-2">Nominal (Rp)</label> <input type="number" id="nominal" min="0" placeholder="100000" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all">
         </div>
        </div>
        <div class="flex gap-4 pt-4"><button type="submit" id="btn-submit" class="flex-1 btn-primary text-white font-semibold py-4 px-6 rounded-xl flex items-center justify-center gap-2 shadow-lg">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg> Simpan Tagihan </button> <button type="button" onclick="resetForm()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-4 px-6 rounded-xl transition-all flex items-center justify-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg> Reset </button>
        </div>
       </form>
      </div><!-- Status Message -->
      <div id="status-message" class="hidden bg-green-50 border-l-4 border-green-500 p-5 rounded-xl shadow-md">
       <div class="flex items-center gap-3">
        <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <p class="text-green-700 font-semibold">Data berhasil disimpan!</p>
       </div>
      </div>
     </div>
    </div><!-- TAB: Tagihan Murid -->
    <div id="content-tagihan" class="tab-content hidden">
     <div class="max-w-6xl mx-auto">
      <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 border border-gray-100 card-shadow">
       <div class="flex items-center gap-3 mb-5">
        <div class="bg-blue-100 p-3 rounded-xl">
         <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
         </svg>
        </div>
        <h2 class="text-xl font-bold text-gray-800">Cari Tagihan Murid</h2>
       </div>
       <div class="flex gap-3"><input type="text" id="search-id-murid" placeholder="Masukkan Nama Murid..." class="flex-1 px-5 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all"> <button onclick="searchTagihan()" class="btn-primary text-white font-semibold px-8 py-3 rounded-xl flex items-center gap-2">
         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
         </svg> Cari </button>
       </div>
      </div><!-- Search Results -->
      <div id="search-results" class="hidden">
       <div class="bg-gradient-to-r from-teal-50 to-cyan-50 rounded-2xl shadow-md p-6 mb-6 border border-teal-100">
        <div class="flex items-center gap-2 mb-4">
         <svg class="w-5 h-5 text-teal-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
         </svg>
         <h3 class="text-lg font-bold text-gray-800">Data Murid</h3>
        </div>
        <div class="grid md:grid-cols-4 gap-4 text-sm">
         <div class="bg-white rounded-xl p-3 shadow-sm"><span class="text-gray-500 text-xs font-medium">Nama</span>
          <p id="result-nama" class="font-bold text-gray-800 mt-1">-</p>
         </div>
         <div class="bg-white rounded-xl p-3 shadow-sm"><span class="text-gray-500 text-xs font-medium">ID Tagihan</span>
          <p id="result-id" class="font-bold text-gray-800 mt-1">-</p>
         </div>
         <div class="bg-white rounded-xl p-3 shadow-sm"><span class="text-gray-500 text-xs font-medium">Kelas</span>
          <p id="result-kelas" class="font-bold text-gray-800 mt-1">-</p>
         </div>
         <div class="bg-white rounded-xl p-3 shadow-sm"><span class="text-gray-500 text-xs font-medium">Jenjang</span>
          <p id="result-jenjang" class="font-bold text-gray-800 mt-1">-</p>
         </div>
        </div>
       </div>
       <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100">
        <div class="flex justify-between items-center mb-5">
         <div class="flex items-center gap-3">
          <div class="bg-purple-100 p-2 rounded-lg">
           <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
           </svg>
          </div>
          <h3 class="text-lg font-bold text-gray-800">Daftar Tagihan</h3>
         </div><button onclick="cetakNota()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-5 py-2.5 rounded-xl text-sm transition-all flex items-center gap-2 shadow-md hover:shadow-lg">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
          </svg> Cetak Nota PDF </button>
        </div>
        <div class="overflow-x-auto rounded-xl border border-gray-200">
         <table class="w-full text-sm">
          <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
           <tr>
            <th class="px-6 py-4 text-left font-semibold text-gray-700">Jenis</th>
            <th class="px-6 py-4 text-left font-semibold text-gray-700">Nama Tagihan</th>
            <th class="px-6 py-4 text-left font-semibold text-gray-700">Nominal</th>
            <th class="px-6 py-4 text-left font-semibold text-gray-700">Status</th>
            <th class="px-6 py-4 text-left font-semibold text-gray-700">Aksi</th>
           </tr>
          </thead>
          <tbody id="tagihan-list"><!-- Dynamic content -->
          </tbody>
         </table>
        </div>
        <div class="mt-6 pt-5 border-t-2 border-gray-200 grid md:grid-cols-2 gap-4">
         <div class="bg-red-50 rounded-xl p-4 border-l-4 border-red-500">
          <p class="text-sm text-red-600 font-medium mb-1">Total Belum Dibayar</p>
          <p id="total-belum-bayar" class="text-2xl font-bold text-red-700">Rp 0</p>
         </div>
         <div class="bg-green-50 rounded-xl p-4 border-l-4 border-green-500">
          <p class="text-sm text-green-600 font-medium mb-1">Total Sudah Dibayar</p>
          <p id="total-sudah-bayar" class="text-2xl font-bold text-green-700">Rp 0</p>
         </div>
        </div>
       </div>
      </div>
      <div id="no-results" class="hidden text-center py-16">
       <div class="bg-white rounded-2xl shadow-md p-12 max-w-md mx-auto">
        <svg class="w-20 h-20 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <p class="text-gray-500 text-lg font-semibold">Tidak ada data untuk nama tersebut</p>
        <p class="text-gray-400 text-sm mt-2">Silakan coba dengan nama lain</p>
       </div>
      </div>
     </div>
    </div><!-- TAB: Laporan -->
    <div id="content-laporan" class="tab-content hidden">
     <div class="max-w-7xl mx-auto">
      <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 border border-gray-100">
       <div class="flex items-center gap-3 mb-6">
        <div class="bg-indigo-100 p-3 rounded-xl">
         <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
         </svg>
        </div>
        <h2 class="text-2xl font-bold text-gray-800">Laporan Tagihan</h2>
       </div>
       <div class="grid md:grid-cols-3 gap-5 mb-6">
        <div class="stat-card rounded-xl p-5 shadow-md" style="--bg-start: #eff6ff; --bg-end: #dbeafe; --border-color: #3b82f6;">
         <div class="flex items-center justify-between">
          <div>
           <p class="text-blue-600 text-sm font-semibold mb-2">Total Tagihan</p>
           <p id="stat-total" class="text-3xl font-bold text-blue-700">0</p>
          </div>
          <div class="bg-blue-100 p-3 rounded-xl">
           <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
           </svg>
          </div>
         </div>
        </div>
        <div class="stat-card rounded-xl p-5 shadow-md" style="--bg-start: #f0fdf4; --bg-end: #dcfce7; --border-color: #22c55e;">
         <div class="flex items-center justify-between">
          <div>
           <p class="text-green-600 text-sm font-semibold mb-2">Sudah Dibayar</p>
           <p id="stat-lunas" class="text-3xl font-bold text-green-700">0</p>
          </div>
          <div class="bg-green-100 p-3 rounded-xl">
           <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
           </svg>
          </div>
         </div>
        </div>
        <div class="stat-card rounded-xl p-5 shadow-md" style="--bg-start: #fef2f2; --bg-end: #fee2e2; --border-color: #ef4444;">
         <div class="flex items-center justify-between">
          <div>
           <p class="text-red-600 text-sm font-semibold mb-2">Belum Dibayar</p>
           <p id="stat-belum" class="text-3xl font-bold text-red-700">0</p>
          </div>
          <div class="bg-red-100 p-3 rounded-xl">
           <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
           </svg>
          </div>
         </div>
        </div>
       </div><!-- Filter Section -->
       <div class="bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl p-5 mb-5 border border-gray-200">
        <div class="flex items-center gap-2 mb-4">
         <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
         </svg>
         <h3 class="font-bold text-gray-700">Filter Data</h3>
        </div>
        <div class="grid md:grid-cols-4 gap-3"><input type="text" id="filter-nama" placeholder="Cari nama..." onkeyup="applyFilters()" class="px-4 py-2.5 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 text-sm"> <input type="text" id="filter-id-murid-laporan" placeholder="Cari ID tagihan..." onkeyup="applyFilters()" class="px-4 py-2.5 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 text-sm"> <select id="filter-status" onchange="applyFilters()" class="px-4 py-2.5 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 text-sm bg-white"> <option value="">Semua Status</option> <option value="lunas">Lunas</option> <option value="belum_bayar">Belum Bayar</option> </select> <button onclick="resetFilters()" class="px-4 py-2.5 bg-gray-300 hover:bg-gray-400 text-gray-700 font-semibold rounded-xl transition text-sm flex items-center justify-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg> Reset </button>
        </div>
       </div><!-- Action Buttons -->
       <div class="flex flex-wrap gap-3 mb-5"><button onclick="exportData()" class="bg-green-600 hover:bg-green-700 text-white font-semibold px-5 py-3 rounded-xl transition-all text-sm flex items-center gap-2 shadow-md hover:shadow-lg">
         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
         </svg> Export Semua ke CSV </button> <button onclick="exportSelectedData()" id="btn-export-selected" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-5 py-3 rounded-xl transition-all text-sm flex items-center gap-2 shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
         </svg> Export Terpilih (<span id="count-selected">0</span>) </button> <button onclick="hapusTerpilih()" id="btn-hapus-selected" class="bg-red-600 hover:bg-red-700 text-white font-semibold px-5 py-3 rounded-xl transition-all text-sm flex items-center gap-2 shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
         </svg> Hapus Terpilih (<span id="count-selected-hapus">0</span>) </button>
       </div>
       <div class="overflow-x-auto rounded-xl border border-gray-200">
        <table class="w-full text-sm">
         <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
          <tr>
           <th class="px-5 py-4 text-left"><input type="checkbox" id="check-all" onchange="toggleCheckAll()" class="w-4 h-4 text-teal-600 rounded focus:ring-2 focus:ring-teal-500"></th>
           <th class="px-5 py-4 text-left font-semibold text-gray-700">ID Tagihan</th>
           <th class="px-5 py-4 text-left font-semibold text-gray-700">Nama</th>
           <th class="px-5 py-4 text-left font-semibold text-gray-700">Kelas</th>
           <th class="px-5 py-4 text-left font-semibold text-gray-700">Tagihan</th>
           <th class="px-5 py-4 text-left font-semibold text-gray-700">Nominal</th>
           <th class="px-5 py-4 text-left font-semibold text-gray-700">Status</th>
           <th class="px-5 py-4 text-left font-semibold text-gray-700">Tanggal Bayar</th>
           <th class="px-5 py-4 text-left font-semibold text-gray-700">Aksi</th>
          </tr>
         </thead>
         <tbody id="laporan-list"><!-- Dynamic content -->
         </tbody>
        </table>
       </div>
      </div>
     </div>
    </div><!-- TAB: Pengaturan -->
    <div id="content-pengaturan" class="tab-content hidden">
     <div class="max-w-6xl mx-auto space-y-6"><!-- Pengaturan Nama Sekolah -->
      <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100 card-shadow">
       <div class="flex items-center gap-3 mb-5">
        <div class="bg-purple-100 p-3 rounded-xl">
         <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
         </svg>
        </div>
        <h2 class="text-xl font-bold text-gray-800">Pengaturan Nama Sekolah</h2>
       </div>
       <div class="space-y-4">
        <div><label for="input-nama-sekolah" class="block text-sm font-semibold text-gray-700 mb-2">Nama Sekolah</label> <input type="text" id="input-nama-sekolah" placeholder="Contoh: SD Negeri 1 Jakarta" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 transition-all">
        </div>
        <div><label for="input-alamat-sekolah" class="block text-sm font-semibold text-gray-700 mb-2">Alamat Sekolah</label> <input type="text" id="input-alamat-sekolah" placeholder="Contoh: Jl. Pendidikan No. 123" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 transition-all">
        </div><button onclick="simpanNamaSekolah()" class="btn-primary text-white font-semibold px-6 py-3 rounded-xl flex items-center gap-2 shadow-lg">
         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
         </svg> Simpan Pengaturan Sekolah </button>
       </div>
      </div><!-- Pengaturan Jenis Tagihan -->
      <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100 card-shadow">
       <div class="flex items-center gap-3 mb-5">
        <div class="bg-blue-100 p-3 rounded-xl">
         <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
         </svg>
        </div>
        <h2 class="text-xl font-bold text-gray-800">Kelola Jenis Tagihan</h2>
       </div>
       <div class="mb-4">
        <div class="flex gap-3 mb-4"><input type="text" id="input-jenis-tagihan" placeholder="Tambah jenis tagihan baru..." class="flex-1 px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 transition-all"> <button onclick="tambahJenisTagihan()" class="btn-primary text-white font-semibold px-6 py-3 rounded-xl flex items-center gap-2 shadow-lg">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
          </svg> Tambah </button>
        </div>
        <div id="list-jenis-tagihan" class="space-y-2"><!-- Dynamic list -->
        </div>
       </div>
      </div><!-- Pengaturan Jenjang -->
      <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100 card-shadow">
       <div class="flex items-center gap-3 mb-5">
        <div class="bg-green-100 p-3 rounded-xl">
         <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
         </svg>
        </div>
        <h2 class="text-xl font-bold text-gray-800">Kelola Jenjang</h2>
       </div>
       <div class="mb-4">
        <div class="flex gap-3 mb-4"><input type="text" id="input-jenjang" placeholder="Tambah jenjang baru..." class="flex-1 px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 transition-all"> <button onclick="tambahJenjang()" class="btn-primary text-white font-semibold px-6 py-3 rounded-xl flex items-center gap-2 shadow-lg">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
          </svg> Tambah </button>
        </div>
        <div id="list-jenjang" class="space-y-2"><!-- Dynamic list -->
        </div>
       </div>
      </div><!-- Pengaturan Kelas -->
      <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100 card-shadow">
       <div class="flex items-center gap-3 mb-5">
        <div class="bg-yellow-100 p-3 rounded-xl">
         <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
         </svg>
        </div>
        <h2 class="text-xl font-bold text-gray-800">Kelola Kelas</h2>
       </div>
       <div class="mb-4">
        <div class="flex gap-3 mb-4"><input type="text" id="input-kelas" placeholder="Tambah kelas baru (contoh: 1A, 2B)..." class="flex-1 px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 transition-all"> <button onclick="tambahKelas()" class="btn-primary text-white font-semibold px-6 py-3 rounded-xl flex items-center gap-2 shadow-lg">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
          </svg> Tambah </button>
        </div>
        <div id="list-kelas" class="space-y-2"><!-- Dynamic list -->
        </div>
       </div>
      </div><!-- Pengaturan Field Form -->
      <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100 card-shadow">
       <div class="flex items-center gap-3 mb-5">
        <div class="bg-indigo-100 p-3 rounded-xl">
         <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
         </svg>
        </div>
        <div>
         <h2 class="text-xl font-bold text-gray-800">Atur Field Form Input</h2>
         <p class="text-sm text-gray-500 mt-1">Centang field yang ingin ditampilkan di form input tagihan</p>
        </div>
       </div>
       <div class="space-y-3"><label class="flex items-center gap-3 p-4 border-2 border-gray-200 rounded-xl hover:bg-gray-50 cursor-not-allowed opacity-60"> <input type="checkbox" id="field-nama-murid" checked disabled class="w-5 h-5 text-teal-600 rounded">
         <div class="flex-1"><span class="font-semibold text-gray-700">Nama Murid</span> <span class="ml-2 text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">wajib</span>
         </div></label> <label class="flex items-center gap-3 p-4 border-2 border-gray-200 rounded-xl hover:bg-gray-50 cursor-not-allowed opacity-60"> <input type="checkbox" id="field-id-murid" checked disabled class="w-5 h-5 text-teal-600 rounded">
         <div class="flex-1"><span class="font-semibold text-gray-700">ID Murid</span> <span class="ml-2 text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">wajib, auto-generate</span>
         </div></label> <label class="flex items-center gap-3 p-4 border-2 border-teal-200 rounded-xl hover:bg-teal-50 cursor-pointer transition-all"> <input type="checkbox" id="field-kelas" onchange="saveFormFieldSettings()" class="w-5 h-5 text-teal-600 rounded"> <span class="font-semibold text-gray-700">Kelas</span> </label> <label class="flex items-center gap-3 p-4 border-2 border-teal-200 rounded-xl hover:bg-teal-50 cursor-pointer transition-all"> <input type="checkbox" id="field-jenjang" onchange="saveFormFieldSettings()" class="w-5 h-5 text-teal-600 rounded"> <span class="font-semibold text-gray-700">Jenjang</span> </label> <label class="flex items-center gap-3 p-4 border-2 border-teal-200 rounded-xl hover:bg-teal-50 cursor-pointer transition-all"> <input type="checkbox" id="field-tahun-ajaran" onchange="saveFormFieldSettings()" class="w-5 h-5 text-teal-600 rounded"> <span class="font-semibold text-gray-700">Tahun Ajaran</span> </label> <label class="flex items-center gap-3 p-4 border-2 border-gray-200 rounded-xl hover:bg-gray-50 cursor-not-allowed opacity-60"> <input type="checkbox" id="field-jenis-tagihan" checked disabled class="w-5 h-5 text-teal-600 rounded">
         <div class="flex-1"><span class="font-semibold text-gray-700">Jenis Tagihan</span> <span class="ml-2 text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">wajib</span>
         </div></label> <label class="flex items-center gap-3 p-4 border-2 border-gray-200 rounded-xl hover:bg-gray-50 cursor-not-allowed opacity-60"> <input type="checkbox" id="field-nama-tagihan" checked disabled class="w-5 h-5 text-teal-600 rounded">
         <div class="flex-1"><span class="font-semibold text-gray-700">Nama Tagihan</span> <span class="ml-2 text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">wajib</span>
         </div></label> <label class="flex items-center gap-3 p-4 border-2 border-gray-200 rounded-xl hover:bg-gray-50 cursor-not-allowed opacity-60"> <input type="checkbox" id="field-nominal" checked disabled class="w-5 h-5 text-teal-600 rounded">
         <div class="flex-1"><span class="font-semibold text-gray-700">Nominal</span> <span class="ml-2 text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">wajib</span>
         </div></label>
       </div>
      </div>
     </div>
    </div>
   </main>
  </div>
  <script>
    const defaultConfig = {
      app_title: 'Sistem Informasi Tagihan Murid',
      school_name: 'SD Negeri 1 Contoh',
      school_address: 'Jl. Pendidikan No. 123',
      primary_color: '#0f766e',
      secondary_color: '#f8fafc',
      text_color: '#1f2937',
      accent_color: '#0d9488',
      button_color: '#2563eb',
      font_family: 'Inter',
      font_size: 16
    };

    let config = { ...defaultConfig };
    let allData = [];
    let currentSearchData = null;

    // Settings Configuration
    let settings = {
      jenisTagihan: ['SPP Bulanan', 'Iuran Ujian', 'Iuran Raport'],
      jenjang: ['SD', 'SMP', 'SMA'],
      kelas: [],
      formFields: {
        kelas: true,
        jenjang: true,
        tahun_ajaran: true
      },
      defaultJenisTagihan: '',
      defaultJenjang: '',
      defaultKelas: '',
      namaSekolah: 'SD Negeri 1 Contoh',
      alamatSekolah: 'Jl. Pendidikan No. 123'
    };

    // Generate unique ID for Tagihan
    function generateUniqueId() {
      return 'TGH-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
    }

    // Toggle Bulk Input Mode
    function toggleBulkInput() {
      const isChecked = document.getElementById('bulk-input-toggle').checked;
      const normalInput = document.getElementById('nama-murid');
      const bulkInput = document.getElementById('nama-murid-bulk');
      const bulkHint = document.getElementById('bulk-hint');
      
      if (isChecked) {
        // Mode BULK
        normalInput.classList.add('hidden');
        normalInput.value = '';
        bulkInput.classList.remove('hidden');
        bulkHint.classList.remove('hidden');
      } else {
        // Mode SINGLE
        normalInput.classList.remove('hidden');
        bulkInput.classList.add('hidden');
        bulkInput.value = '';
        bulkHint.classList.add('hidden');
      }
    }

    // LocalStorage Management
    function loadData() {
      const saved = localStorage.getItem('tagihan_data');
      if (saved) {
        allData = JSON.parse(saved);
        updateLaporan();
      }
      
      const savedSettings = localStorage.getItem('tagihan_settings');
      if (savedSettings) {
        settings = JSON.parse(savedSettings);
      }
    }

    function saveData() {
      localStorage.setItem('tagihan_data', JSON.stringify(allData));
      updateLaporan();
      
      if (currentSearchData) {
        const idMurid = document.getElementById('search-id-murid').value.trim();
        if (idMurid) {
          renderSearchResults(idMurid);
        }
      }
    }

    function saveSettings() {
      localStorage.setItem('tagihan_settings', JSON.stringify(settings));
      updateFormFields();
    }

    // Initialize App
    function initApp() {
      loadData();
      updateFormFields();
      renderJenisTagihanList();
      renderJenjangList();
      renderKelasList();
      loadFormFieldSettings();
      loadNamaSekolahSettings();
      
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange,
          mapToCapabilities,
          mapToEditPanelValues
        });
      }
    }

    async function onConfigChange(cfg) {
      config = { ...defaultConfig, ...cfg };
      
      document.getElementById('app-title').textContent = config.app_title || defaultConfig.app_title;
      document.getElementById('school-name').textContent = config.school_name || defaultConfig.school_name;
      
      const customFont = config.font_family || defaultConfig.font_family;
      document.body.style.fontFamily = `${customFont}, sans-serif`;
      
      const baseSize = config.font_size || defaultConfig.font_size;
      document.documentElement.style.fontSize = `${baseSize}px`;
    }

    function mapToCapabilities(cfg) {
      return {
        recolorables: [
          {
            get: () => cfg.primary_color || defaultConfig.primary_color,
            set: (value) => { cfg.primary_color = value; if (window.elementSdk) window.elementSdk.setConfig({ primary_color: value }); }
          },
          {
            get: () => cfg.secondary_color || defaultConfig.secondary_color,
            set: (value) => { cfg.secondary_color = value; if (window.elementSdk) window.elementSdk.setConfig({ secondary_color: value }); }
          },
          {
            get: () => cfg.text_color || defaultConfig.text_color,
            set: (value) => { cfg.text_color = value; if (window.elementSdk) window.elementSdk.setConfig({ text_color: value }); }
          },
          {
            get: () => cfg.accent_color || defaultConfig.accent_color,
            set: (value) => { cfg.accent_color = value; if (window.elementSdk) window.elementSdk.setConfig({ accent_color: value }); }
          },
          {
            get: () => cfg.button_color || defaultConfig.button_color,
            set: (value) => { cfg.button_color = value; if (window.elementSdk) window.elementSdk.setConfig({ button_color: value }); }
          }
        ],
        borderables: [],
        fontEditable: {
          get: () => cfg.font_family || defaultConfig.font_family,
          set: (value) => { cfg.font_family = value; if (window.elementSdk) window.elementSdk.setConfig({ font_family: value }); }
        },
        fontSizeable: {
          get: () => cfg.font_size || defaultConfig.font_size,
          set: (value) => { cfg.font_size = value; if (window.elementSdk) window.elementSdk.setConfig({ font_size: value }); }
        }
      };
    }

    function mapToEditPanelValues(cfg) {
      return new Map([
        ['app_title', cfg.app_title || defaultConfig.app_title],
        ['school_name', cfg.school_name || defaultConfig.school_name],
        ['school_address', cfg.school_address || defaultConfig.school_address]
      ]);
    }

    // Tab Navigation
    function switchTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
      document.querySelectorAll('nav button').forEach(el => el.classList.remove('tab-active'));
      
      document.getElementById(`content-${tabName}`).classList.remove('hidden');
      document.getElementById(`tab-${tabName}`).classList.add('tab-active');
    }

    // Settings Management - Jenis Tagihan
    function tambahJenisTagihan() {
      const input = document.getElementById('input-jenis-tagihan');
      const value = input.value.trim();
      
      if (!value) {
        showCustomAlert('Masukkan jenis tagihan terlebih dahulu');
        return;
      }
      
      if (settings.jenisTagihan.includes(value)) {
        showCustomAlert('Jenis tagihan sudah ada');
        return;
      }
      
      settings.jenisTagihan.push(value);
      saveSettings();
      renderJenisTagihanList();
      input.value = '';
    }

    function hapusJenisTagihan(index) {
      settings.jenisTagihan.splice(index, 1);
      if (settings.defaultJenisTagihan === settings.jenisTagihan[index]) {
        settings.defaultJenisTagihan = '';
      }
      saveSettings();
      renderJenisTagihanList();
    }

    function setDefaultJenisTagihan(value) {
      settings.defaultJenisTagihan = value;
      saveSettings();
      renderJenisTagihanList();
    }

    function renderJenisTagihanList() {
      const container = document.getElementById('list-jenis-tagihan');
      container.innerHTML = '';
      
      settings.jenisTagihan.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'flex items-center gap-3 p-4 bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl border border-gray-200 hover:shadow-md transition-all';
        div.innerHTML = `
          <input type="radio" name="default-jenis" ${settings.defaultJenisTagihan === item ? 'checked' : ''} 
                 onchange="setDefaultJenisTagihan('${item}')" 
                 class="w-4 h-4 text-teal-600" title="Jadikan default">
          <span class="flex-1 font-semibold text-gray-700">${item}</span>
          <button onclick="hapusJenisTagihan(${index})" class="text-red-600 hover:text-red-700 px-3 py-2 text-sm font-semibold rounded-lg hover:bg-red-50 transition-all flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
            Hapus
          </button>
        `;
        container.appendChild(div);
      });
      
      updateFormDropdowns();
    }

    // Settings Management - Jenjang
    function tambahJenjang() {
      const input = document.getElementById('input-jenjang');
      const value = input.value.trim();
      
      if (!value) {
        showCustomAlert('Masukkan jenjang terlebih dahulu');
        return;
      }
      
      if (settings.jenjang.includes(value)) {
        showCustomAlert('Jenjang sudah ada');
        return;
      }
      
      settings.jenjang.push(value);
      saveSettings();
      renderJenjangList();
      input.value = '';
    }

    function hapusJenjang(index) {
      settings.jenjang.splice(index, 1);
      if (settings.defaultJenjang === settings.jenjang[index]) {
        settings.defaultJenjang = '';
      }
      saveSettings();
      renderJenjangList();
    }

    function setDefaultJenjang(value) {
      settings.defaultJenjang = value;
      saveSettings();
      renderJenjangList();
    }

    function renderJenjangList() {
      const container = document.getElementById('list-jenjang');
      container.innerHTML = '';
      
      settings.jenjang.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'flex items-center gap-3 p-4 bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl border border-gray-200 hover:shadow-md transition-all';
        div.innerHTML = `
          <input type="radio" name="default-jenjang" ${settings.defaultJenjang === item ? 'checked' : ''} 
                 onchange="setDefaultJenjang('${item}')" 
                 class="w-4 h-4 text-teal-600" title="Jadikan default">
          <span class="flex-1 font-semibold text-gray-700">${item}</span>
          <button onclick="hapusJenjang(${index})" class="text-red-600 hover:text-red-700 px-3 py-2 text-sm font-semibold rounded-lg hover:bg-red-50 transition-all flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
            Hapus
          </button>
        `;
        container.appendChild(div);
      });
      
      updateFormDropdowns();
    }

    // Settings Management - Kelas
    function tambahKelas() {
      const input = document.getElementById('input-kelas');
      const value = input.value.trim();
      
      if (!value) {
        showCustomAlert('Masukkan kelas terlebih dahulu');
        return;
      }
      
      if (settings.kelas.includes(value)) {
        showCustomAlert('Kelas sudah ada');
        return;
      }
      
      settings.kelas.push(value);
      saveSettings();
      renderKelasList();
      input.value = '';
    }

    function hapusKelas(index) {
      settings.kelas.splice(index, 1);
      if (settings.defaultKelas === settings.kelas[index]) {
        settings.defaultKelas = '';
      }
      saveSettings();
      renderKelasList();
    }

    function setDefaultKelas(value) {
      settings.defaultKelas = value;
      saveSettings();
      renderKelasList();
    }

    function renderKelasList() {
      const container = document.getElementById('list-kelas');
      container.innerHTML = '';
      
      if (settings.kelas.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-sm italic p-4 bg-gray-50 rounded-xl">Belum ada kelas. Tambahkan kelas baru di atas.</p>';
        updateFormDropdowns();
        return;
      }
      
      settings.kelas.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'flex items-center gap-3 p-4 bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl border border-gray-200 hover:shadow-md transition-all';
        div.innerHTML = `
          <input type="radio" name="default-kelas" ${settings.defaultKelas === item ? 'checked' : ''} 
                 onchange="setDefaultKelas('${item}')" 
                 class="w-4 h-4 text-teal-600" title="Jadikan default">
          <span class="flex-1 font-semibold text-gray-700">${item}</span>
          <button onclick="hapusKelas(${index})" class="text-red-600 hover:text-red-700 px-3 py-2 text-sm font-semibold rounded-lg hover:bg-red-50 transition-all flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
            Hapus
          </button>
        `;
        container.appendChild(div);
      });
      
      updateFormDropdowns();
    }

    // Update Form Dropdowns
    function updateFormDropdowns() {
      // Update Jenis Tagihan
      const selectJenis = document.getElementById('jenis-tagihan');
      const currentJenis = selectJenis.value;
      selectJenis.innerHTML = '<option value="">-- Pilih Jenis --</option>';
      settings.jenisTagihan.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item;
        opt.textContent = item;
        selectJenis.appendChild(opt);
      });
      selectJenis.value = settings.defaultJenisTagihan || currentJenis || '';
      
      // Update Jenjang
      const selectJenjang = document.getElementById('jenjang');
      const currentJenjang = selectJenjang.value;
      selectJenjang.innerHTML = '<option value="">-- Pilih Jenjang --</option>';
      settings.jenjang.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item;
        opt.textContent = item;
        selectJenjang.appendChild(opt);
      });
      selectJenjang.value = settings.defaultJenjang || currentJenjang || '';
      
      // Update Kelas
      const selectKelas = document.getElementById('kelas');
      const currentKelas = selectKelas.value;
      selectKelas.innerHTML = '<option value="">-- Pilih Kelas --</option>';
      settings.kelas.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item;
        opt.textContent = item;
        selectKelas.appendChild(opt);
      });
      selectKelas.value = settings.defaultKelas || currentKelas || '';
    }

    // Form Field Settings
    function saveFormFieldSettings() {
      settings.formFields.kelas = document.getElementById('field-kelas').checked;
      settings.formFields.jenjang = document.getElementById('field-jenjang').checked;
      settings.formFields.tahun_ajaran = document.getElementById('field-tahun-ajaran').checked;
      saveSettings();
    }

    function loadFormFieldSettings() {
      document.getElementById('field-kelas').checked = settings.formFields.kelas;
      document.getElementById('field-jenjang').checked = settings.formFields.jenjang;
      document.getElementById('field-tahun-ajaran').checked = settings.formFields.tahun_ajaran;
    }

    // Nama Sekolah Settings
    function simpanNamaSekolah() {
      const nama = document.getElementById('input-nama-sekolah').value.trim();
      const alamat = document.getElementById('input-alamat-sekolah').value.trim();
      
      if (!nama) {
        showCustomAlert('Nama sekolah tidak boleh kosong');
        return;
      }
      
      settings.namaSekolah = nama;
      settings.alamatSekolah = alamat;
      saveSettings();
      
      // Update display
      document.getElementById('school-name').textContent = nama;
      
      showCustomAlert('Pengaturan sekolah berhasil disimpan!');
    }

    function loadNamaSekolahSettings() {
      document.getElementById('input-nama-sekolah').value = settings.namaSekolah;
      document.getElementById('input-alamat-sekolah').value = settings.alamatSekolah;
      document.getElementById('school-name').textContent = settings.namaSekolah;
    }

    function updateFormFields() {
      const kelasWrapper = document.getElementById('kelas').parentElement;
      const jenjangWrapper = document.getElementById('jenjang').parentElement;
      const tahunWrapper = document.getElementById('tahun-ajaran').parentElement;
      
      kelasWrapper.style.display = settings.formFields.kelas ? 'block' : 'none';
      jenjangWrapper.style.display = settings.formFields.jenjang ? 'block' : 'none';
      tahunWrapper.style.display = settings.formFields.tahun_ajaran ? 'block' : 'none';
    }

    // Form Submission dengan Auto Download dan Bulk Input Support
    document.getElementById('form-tagihan').addEventListener('submit', (e) => {
      e.preventDefault();

      const isBulkMode = document.getElementById('bulk-input-toggle').checked;

      // Validasi Nama Murid berdasarkan mode
      let namaMuridList = [];
      
      if (isBulkMode) {
        // MODE BULK
        const namaBulk = document.getElementById('nama-murid-bulk').value.trim();
        
        if (!namaBulk) {
          showCustomAlert('Masukkan minimal satu nama murid');
          return;
        }
        
        namaMuridList = namaBulk.split(',').map(n => n.trim()).filter(n => n.length > 0);
        
        if (namaMuridList.length === 0) {
          showCustomAlert('Masukkan minimal satu nama murid yang valid');
          return;
        }
      } else {
        // MODE SINGLE
        const namaMurid = document.getElementById('nama-murid').value.trim();
        
        if (!namaMurid) {
          showCustomAlert('Nama murid harus diisi');
          return;
        }
        
        namaMuridList = [namaMurid];
      }

      // Validasi field wajib lainnya
      const jenisTagihan = document.getElementById('jenis-tagihan').value.trim();
      const namaTagihan = document.getElementById('nama-tagihan').value.trim();
      const nominalInput = document.getElementById('nominal').value.trim();

      if (!jenisTagihan) {
        showCustomAlert('Jenis Tagihan harus dipilih');
        return;
      }

      if (!namaTagihan) {
        showCustomAlert('Nama Tagihan harus diisi');
        return;
      }

      if (!nominalInput || parseFloat(nominalInput) <= 0) {
        showCustomAlert('Nominal harus diisi dengan angka lebih dari 0');
        return;
      }

      const nominal = parseFloat(nominalInput);

      // Validasi field opsional sesuai pengaturan
      if (settings.formFields.kelas) {
        const kelas = document.getElementById('kelas').value;
        if (!kelas) {
          showCustomAlert('Kelas harus dipilih');
          return;
        }
      }

      if (settings.formFields.jenjang) {
        const jenjang = document.getElementById('jenjang').value;
        if (!jenjang) {
          showCustomAlert('Jenjang harus dipilih');
          return;
        }
      }

      if (settings.formFields.tahun_ajaran) {
        const tahunAjaran = document.getElementById('tahun-ajaran').value.trim();
        if (!tahunAjaran) {
          showCustomAlert('Tahun Ajaran harus diisi');
          return;
        }
      }

      // Proses simpan data untuk setiap nama murid
      const savedRecords = [];
      
      namaMuridList.forEach(namaMurid => {
        const formData = {
          id: generateUniqueId(),
          nama_murid: namaMurid,
          id_murid: '',
          kelas: settings.formFields.kelas ? (document.getElementById('kelas').value || '') : '',
          jenjang: settings.formFields.jenjang ? (document.getElementById('jenjang').value || '') : '',
          tahun_ajaran: settings.formFields.tahun_ajaran ? (document.getElementById('tahun-ajaran').value || '') : '',
          jenis_tagihan: jenisTagihan,
          nama_tagihan: namaTagihan,
          nominal: nominal,
          status: 'belum_bayar',
          tanggal_bayar: '',
          created_at: new Date().toISOString()
        };
        
        allData.push(formData);
        savedRecords.push(formData);
      });
      
      saveData();

      // Feedback dan download
      if (isBulkMode) {
        showCustomAlert(`${savedRecords.length} tagihan berhasil disimpan!`);
      } else {
        showCustomAlert('Data berhasil disimpan! Nota PDF akan otomatis terunduh.');
        
        // Auto download nota untuk mode single
        setTimeout(() => {
          downloadNotaSingleTagihan(savedRecords[0]);
        }, 500);
      }
      
      resetForm();
    });

    function resetForm() {
      document.getElementById('form-tagihan').reset();
      
      // Reset bulk input toggle and fields
      document.getElementById('bulk-input-toggle').checked = false;
      toggleBulkInput();
      
      // Reset ke default values
      if (settings.defaultJenisTagihan) {
        document.getElementById('jenis-tagihan').value = settings.defaultJenisTagihan;
      }
      if (settings.defaultJenjang) {
        document.getElementById('jenjang').value = settings.defaultJenjang;
      }
      if (settings.defaultKelas) {
        document.getElementById('kelas').value = settings.defaultKelas;
      }
    }

    function showStatusMessage() {
      const msg = document.getElementById('status-message');
      msg.classList.remove('hidden');
      setTimeout(() => msg.classList.add('hidden'), 3000);
    }

    // Search Tagihan
    function searchTagihan() {
      const namaMurid = document.getElementById('search-id-murid').value.trim();
      if (!namaMurid) {
        showCustomAlert('Masukkan Nama Murid terlebih dahulu');
        return;
      }

      renderSearchResults(namaMurid);
    }

    function renderSearchResults(namaMurid) {
      const filtered = allData.filter(item => 
        item.nama_murid.toLowerCase().includes(namaMurid.toLowerCase())
      );
      
      if (filtered.length === 0) {
        document.getElementById('search-results').classList.add('hidden');
        document.getElementById('no-results').classList.remove('hidden');
        currentSearchData = null;
        return;
      }

      currentSearchData = filtered;
      document.getElementById('no-results').classList.add('hidden');
      document.getElementById('search-results').classList.remove('hidden');

      const first = filtered[0];
      document.getElementById('result-nama').textContent = first.nama_murid;
      document.getElementById('result-id').textContent = first.id || '-';
      document.getElementById('result-kelas').textContent = first.kelas;
      document.getElementById('result-jenjang').textContent = first.jenjang;

      const tbody = document.getElementById('tagihan-list');
      tbody.innerHTML = '';

      let totalBelum = 0;
      let totalSudah = 0;

      filtered.forEach(item => {
        const row = document.createElement('tr');
        row.className = 'border-b border-gray-100 hover:bg-teal-50/50 transition-colors';
        
        const badgeClass = item.jenis_tagihan === 'bulanan' 
          ? 'bg-blue-100 text-blue-700 border border-blue-200' 
          : 'bg-purple-100 text-purple-700 border border-purple-200';
        
        const statusBadge = item.status === 'lunas'
          ? '<span class="inline-flex items-center gap-1 px-3 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-700 border border-green-200"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg> Lunas</span>'
          : '<span class="inline-flex items-center gap-1 px-3 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-700 border border-red-200"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/></svg> Belum Bayar</span>';

        const actionBtn = item.status === 'lunas'
          ? '<button disabled class="px-4 py-2 text-xs bg-gray-200 text-gray-500 rounded-lg cursor-not-allowed font-medium">Sudah Dibayar</button>'
          : `<button onclick="konfirmasiBayar('${item.id}')" class="px-4 py-2 text-xs bg-gradient-to-r from-teal-600 to-teal-500 hover:from-teal-700 hover:to-teal-600 text-white rounded-lg transition font-semibold shadow-sm hover:shadow-md flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/></svg> Bayar</button>`;

        if (item.status === 'lunas') {
          totalSudah += item.nominal;
        } else {
          totalBelum += item.nominal;
        }

        row.innerHTML = `
          <td class="px-6 py-4">
            <span class="inline-block px-3 py-1 text-xs font-semibold rounded-full ${badgeClass}">
              ${item.jenis_tagihan}
            </span>
          </td>
          <td class="px-6 py-4 font-semibold text-gray-800">${item.nama_tagihan}</td>
          <td class="px-6 py-4 font-bold text-gray-900">Rp ${item.nominal.toLocaleString('id-ID')}</td>
          <td class="px-6 py-4">${statusBadge}</td>
          <td class="px-6 py-4">${actionBtn}</td>
        `;
        tbody.appendChild(row);
      });

      document.getElementById('total-belum-bayar').textContent = 'Rp ' + totalBelum.toLocaleString('id-ID');
      document.getElementById('total-sudah-bayar').textContent = 'Rp ' + totalSudah.toLocaleString('id-ID');
    }

    function konfirmasiBayar(itemId) {
      const item = allData.find(d => d.id === itemId);
      if (!item) return;

      const overlay = document.createElement('div');
      overlay.className = 'fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4';
      overlay.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full transform transition-all animate-scale-in">
          <div class="bg-gradient-to-r from-teal-600 to-teal-500 px-6 py-5 rounded-t-2xl flex items-center gap-3">
            <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/>
            </svg>
            <h3 class="text-xl font-bold text-white">Konfirmasi Pembayaran</h3>
          </div>
          <div class="p-6">
            <div class="mb-6">
              <div class="bg-gradient-to-r from-teal-50 to-cyan-50 border-l-4 border-teal-500 p-5 rounded-lg mb-4">
                <p class="text-sm text-gray-700 mb-2"><span class="font-semibold">Tagihan:</span> ${item.nama_tagihan}</p>
                <p class="text-sm text-gray-700 mb-3"><span class="font-semibold">Jenis:</span> ${item.jenis_tagihan}</p>
                <p class="text-3xl font-bold text-teal-700 mt-3">Rp ${item.nominal.toLocaleString('id-ID')}</p>
              </div>
              <p class="text-gray-600 text-sm">Apakah Anda yakin ingin mengkonfirmasi pembayaran ini?</p>
            </div>
            <div class="flex gap-3">
              <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold rounded-xl transition-all flex items-center justify-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
                Batalkan
              </button>
              <button onclick="prosesBayar('${itemId}'); this.closest('.fixed').remove();" class="flex-1 px-4 py-3 bg-gradient-to-r from-teal-600 to-teal-500 hover:from-teal-700 hover:to-teal-600 text-white font-semibold rounded-xl transition-all shadow-lg hover:shadow-xl flex items-center justify-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                Konfirmasi Bayar
              </button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);
    }

    function prosesBayar(itemId) {
      const item = allData.find(d => d.id === itemId);
      if (!item) return;

      item.status = 'lunas';
      item.tanggal_bayar = new Date().toISOString();
      
      saveData();
      showCustomAlert('Pembayaran berhasil dikonfirmasi!');
    }

    // Cetak Nota PDF 58mm - ESTETIK
    function cetakNota() {
      if (!currentSearchData || currentSearchData.length === 0) return;
      
      const { jsPDF } = window.jspdf;
      
      // Hitung tinggi yang dibutuhkan
      const estimatedHeight = 250 + (currentSearchData.length * 30);
      
      // 58mm = 164.4 points, tinggi dinamis
      const doc = new jsPDF({
        orientation: 'portrait',
        unit: 'pt',
        format: [164.4, estimatedHeight]
      });

      const first = currentSearchData[0];
      const schoolName = settings.namaSekolah;
      const schoolAddress = settings.alamatSekolah;
      const pageWidth = 164.4;
      const centerX = pageWidth / 2;
      const marginLeft = 12;
      const marginRight = pageWidth - 12;
      
      let y = 20; // Mulai dari posisi yang lebih tinggi
      
      // ============ HEADER ESTETIK ============
      // Border atas dekoratif
      doc.setLineWidth(1.5);
      doc.setDrawColor(13, 148, 136); // Teal color
      doc.line(marginLeft, y, marginRight, y);
      
      y += 8;
      
      // Logo/Icon sekolah (unicode character)
      doc.setFontSize(16);
      doc.text('', centerX, y, { align: 'center' });
      
      y += 14;
      
      // Nama Sekolah - Bold & Besar
      doc.setFontSize(12);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(13, 148, 136);
      const schoolLines = doc.splitTextToSize(schoolName, 140);
      schoolLines.forEach(line => {
        doc.text(line, centerX, y, { align: 'center' });
        y += 12;
      });
      
      y += 2;
      
      // Alamat Sekolah
      doc.setFontSize(7);
      doc.setFont(undefined, 'normal');
      doc.setTextColor(80, 80, 80);
      const addressLines = doc.splitTextToSize(schoolAddress, 140);
      addressLines.forEach(line => {
        doc.text(line, centerX, y, { align: 'center' });
        y += 8;
      });
      
      y += 5;
      
      // Border bawah dekoratif
      doc.setLineWidth(0.5);
      doc.setDrawColor(180, 180, 180);
      doc.line(marginLeft, y, marginRight, y);
      
      y += 3;
      doc.line(marginLeft, y, marginRight, y);
      
      y += 12;
      
      // ============ JUDUL NOTA ============
      doc.setFontSize(11);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(0, 0, 0);
      doc.text('NOTA TAGIHAN SISWA', centerX, y, { align: 'center' });
      
      y += 3;
      
      // Garis bawah judul
      doc.setLineWidth(0.8);
      doc.setDrawColor(13, 148, 136);
      doc.line(centerX - 40, y, centerX + 40, y);
      
      y += 12;
      
      // ============ TANGGAL & NOMOR NOTA ============
      doc.setFontSize(7);
      doc.setFont(undefined, 'normal');
      doc.setTextColor(60, 60, 60);
      const tanggal = new Date().toLocaleDateString('id-ID', { 
        day: '2-digit', 
        month: 'long', 
        year: 'numeric'
      });
      const waktu = new Date().toLocaleTimeString('id-ID', {
        hour: '2-digit',
        minute: '2-digit'
      });
      doc.text(`Tanggal: ${tanggal}`, marginLeft, y);
      y += 9;
      doc.text(`Waktu: ${waktu} WIB`, marginLeft, y);
      y += 9;
      doc.text(`No. Nota: ${Date.now().toString().slice(-8)}`, marginLeft, y);
      
      y += 12;
      
      // ============ DATA MURID - BOX STYLE ============
      doc.setFillColor(245, 250, 250);
      doc.roundedRect(marginLeft, y, marginRight - marginLeft, 42, 2, 2, 'F');
      
      y += 10;
      
      doc.setFontSize(7);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(13, 148, 136);
      doc.text('DATA SISWA', marginLeft + 3, y);
      
      y += 10;
      
      doc.setFont(undefined, 'normal');
      doc.setTextColor(40, 40, 40);
      doc.setFontSize(7.5);
      
      const muridInfo = [
        `Nama: ${first.nama_murid}`,
        `ID Tagihan: ${first.id}`,
        `Kelas: ${first.kelas} - ${first.jenjang}`,
        `Tahun Ajaran: ${first.tahun_ajaran}`
      ];
      
      muridInfo.forEach(info => {
        doc.text(info, marginLeft + 3, y);
        y += 8;
      });
      
      y += 8;
      
      // ============ DAFTAR TAGIHAN ============
      doc.setFontSize(8);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(0, 0, 0);
      doc.text('RINCIAN TAGIHAN', marginLeft, y);
      
      y += 3;
      doc.setLineWidth(0.5);
      doc.setDrawColor(200, 200, 200);
      doc.line(marginLeft, y, marginRight, y);
      
      y += 10;
      
      let totalBelum = 0;
      let totalLunas = 0;

      currentSearchData.forEach((item, idx) => {
        // Background zebra untuk setiap item
        if (idx % 2 === 0) {
          doc.setFillColor(250, 250, 250);
          doc.rect(marginLeft, y - 7, marginRight - marginLeft, 26, 'F');
        }
        
        // Nomor dan nama tagihan
        doc.setFont(undefined, 'bold');
        doc.setFontSize(7.5);
        doc.setTextColor(40, 40, 40);
        doc.text(`${idx + 1}. ${item.nama_tagihan}`, marginLeft + 2, y);
        
        y += 8;
        
        // Jenis tagihan
        doc.setFont(undefined, 'normal');
        doc.setFontSize(6.5);
        doc.setTextColor(100, 100, 100);
        doc.text(`   ${item.jenis_tagihan}`, marginLeft + 2, y);
        
        y += 8;
        
        // Nominal
        doc.setFont(undefined, 'bold');
        doc.setFontSize(7.5);
        doc.setTextColor(0, 0, 0);
        const nominal = `Rp ${item.nominal.toLocaleString('id-ID')}`;
        doc.text(nominal, marginLeft + 2, y);
        
        // Status badge
        doc.setFontSize(6.5);
        if (item.status === 'lunas') {
          doc.setTextColor(34, 139, 34);
          doc.text('[LUNAS]', marginRight - 2, y, { align: 'right' });
          totalLunas += item.nominal;
          
          // Tanggal bayar
          if (item.tanggal_bayar) {
            y += 7;
            doc.setFont(undefined, 'italic');
            doc.setFontSize(6);
            doc.setTextColor(100, 100, 100);
            const tglBayar = new Date(item.tanggal_bayar).toLocaleDateString('id-ID');
            doc.text(`   Dibayar: ${tglBayar}`, marginLeft + 2, y);
          }
        } else {
          doc.setTextColor(220, 38, 38);
          doc.text('[BELUM]', marginRight - 2, y, { align: 'right' });
          totalBelum += item.nominal;
        }
        
        y += 12;
      });

      y += 5;
      
      // ============ TOTAL - HIGHLIGHT BOX ============
      doc.setLineWidth(1);
      doc.setDrawColor(13, 148, 136);
      doc.line(marginLeft, y, marginRight, y);
      
      y += 10;
      
      // Background untuk total
      doc.setFillColor(240, 253, 250);
      doc.roundedRect(marginLeft, y - 5, marginRight - marginLeft, 28, 2, 2, 'F');
      
      // Total Belum Bayar
      doc.setFont(undefined, 'bold');
      doc.setFontSize(7.5);
      doc.setTextColor(220, 38, 38);
      doc.text('Belum Dibayar:', marginLeft + 3, y);
      doc.text(`Rp ${totalBelum.toLocaleString('id-ID')}`, marginRight - 3, y, { align: 'right' });
      
      y += 10;
      
      // Total Sudah Bayar
      doc.setTextColor(34, 139, 34);
      doc.text('Sudah Dibayar:', marginLeft + 3, y);
      doc.text(`Rp ${totalLunas.toLocaleString('id-ID')}`, marginRight - 3, y, { align: 'right' });
      
      y += 12;
      
      // Grand total border
      doc.setLineWidth(1.5);
      doc.setDrawColor(13, 148, 136);
      doc.line(marginLeft, y, marginRight, y);
      
      y += 2;
      doc.line(marginLeft, y, marginRight, y);
      
      y += 15;
      
      // ============ FOOTER ============
      doc.setFontSize(6.5);
      doc.setFont(undefined, 'italic');
      doc.setTextColor(100, 100, 100);
      doc.text('Terima kasih atas perhatian Anda', centerX, y, { align: 'center' });
      
      y += 8;
      doc.text('Simpan nota ini sebagai bukti pembayaran', centerX, y, { align: 'center' });
      
      y += 10;
      
      // Decorative bottom border
      doc.setLineWidth(1.5);
      doc.setDrawColor(13, 148, 136);
      doc.line(marginLeft, y, marginRight, y);
      
      y += 15;
      
      // Adjust page height sesuai konten
      const finalHeight = y + 5;
      doc.internal.pageSize.height = finalHeight;

      doc.save(`Nota_${first.id}_${tanggal.replace(/\s/g, '_')}.pdf`);
    }

    // Download Nota Single Tagihan (setelah input) - ESTETIK
    function downloadNotaSingleTagihan(item) {
      const { jsPDF } = window.jspdf;
      
      const doc = new jsPDF({
        orientation: 'portrait',
        unit: 'pt',
        format: [164.4, 350]
      });

      const schoolName = settings.namaSekolah;
      const schoolAddress = settings.alamatSekolah;
      const pageWidth = 164.4;
      const centerX = pageWidth / 2;
      const marginLeft = 12;
      const marginRight = pageWidth - 12;
      
      let y = 20;
      
      // ============ HEADER ESTETIK ============
      doc.setLineWidth(1.5);
      doc.setDrawColor(13, 148, 136);
      doc.line(marginLeft, y, marginRight, y);
      
      y += 8;
      
      doc.setFontSize(16);
      doc.text('', centerX, y, { align: 'center' });
      
      y += 14;
      
      doc.setFontSize(12);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(13, 148, 136);
      const schoolLines = doc.splitTextToSize(schoolName, 140);
      schoolLines.forEach(line => {
        doc.text(line, centerX, y, { align: 'center' });
        y += 12;
      });
      
      y += 2;
      
      doc.setFontSize(7);
      doc.setFont(undefined, 'normal');
      doc.setTextColor(80, 80, 80);
      const addressLines = doc.splitTextToSize(schoolAddress, 140);
      addressLines.forEach(line => {
        doc.text(line, centerX, y, { align: 'center' });
        y += 8;
      });
      
      y += 5;
      
      doc.setLineWidth(0.5);
      doc.setDrawColor(180, 180, 180);
      doc.line(marginLeft, y, marginRight, y);
      
      y += 3;
      doc.line(marginLeft, y, marginRight, y);
      
      y += 12;
      
      // ============ JUDUL ============
      doc.setFontSize(11);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(0, 0, 0);
      doc.text('NOTA TAGIHAN SISWA', centerX, y, { align: 'center' });
      
      y += 3;
      
      doc.setLineWidth(0.8);
      doc.setDrawColor(13, 148, 136);
      doc.line(centerX - 40, y, centerX + 40, y);
      
      y += 12;
      
      // ============ TANGGAL ============
      doc.setFontSize(7);
      doc.setFont(undefined, 'normal');
      doc.setTextColor(60, 60, 60);
      const tanggal = new Date().toLocaleDateString('id-ID', { 
        day: '2-digit', 
        month: 'long', 
        year: 'numeric'
      });
      const waktu = new Date().toLocaleTimeString('id-ID', {
        hour: '2-digit',
        minute: '2-digit'
      });
      doc.text(`Tanggal: ${tanggal}`, marginLeft, y);
      y += 9;
      doc.text(`Waktu: ${waktu} WIB`, marginLeft, y);
      y += 9;
      doc.text(`No. Nota: ${Date.now().toString().slice(-8)}`, marginLeft, y);
      
      y += 12;
      
      // ============ DATA MURID ============
      doc.setFillColor(245, 250, 250);
      doc.roundedRect(marginLeft, y, marginRight - marginLeft, 42, 2, 2, 'F');
      
      y += 10;
      
      doc.setFontSize(7);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(13, 148, 136);
      doc.text('DATA SISWA', marginLeft + 3, y);
      
      y += 10;
      
      doc.setFont(undefined, 'normal');
      doc.setTextColor(40, 40, 40);
      doc.setFontSize(7.5);
      
      const muridInfo = [
        `Nama: ${item.nama_murid}`,
        `ID Tagihan: ${item.id}`,
        `Kelas: ${item.kelas} - ${item.jenjang}`,
        `Tahun Ajaran: ${item.tahun_ajaran}`
      ];
      
      muridInfo.forEach(info => {
        doc.text(info, marginLeft + 3, y);
        y += 8;
      });
      
      y += 10;
      
      // ============ TAGIHAN ============
      doc.setFontSize(8);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(0, 0, 0);
      doc.text('RINCIAN TAGIHAN', marginLeft, y);
      
      y += 3;
      doc.setLineWidth(0.5);
      doc.setDrawColor(200, 200, 200);
      doc.line(marginLeft, y, marginRight, y);
      
      y += 12;
      
      // Item box
      doc.setFillColor(250, 250, 250);
      doc.rect(marginLeft, y - 7, marginRight - marginLeft, 32, 'F');
      
      doc.setFont(undefined, 'bold');
      doc.setFontSize(7.5);
      doc.setTextColor(40, 40, 40);
      doc.text(`${item.nama_tagihan}`, marginLeft + 2, y);
      
      y += 8;
      
      doc.setFont(undefined, 'normal');
      doc.setFontSize(6.5);
      doc.setTextColor(100, 100, 100);
      doc.text(`${item.jenis_tagihan}`, marginLeft + 2, y);
      
      y += 10;
      
      doc.setFont(undefined, 'bold');
      doc.setFontSize(9);
      doc.setTextColor(0, 0, 0);
      doc.text(`Rp ${item.nominal.toLocaleString('id-ID')}`, marginLeft + 2, y);
      
      y += 15;
      
      // ============ STATUS ============
      doc.setLineWidth(1);
      doc.setDrawColor(13, 148, 136);
      doc.line(marginLeft, y, marginRight, y);
      
      y += 12;
      
      doc.setFillColor(254, 242, 242);
      doc.roundedRect(marginLeft, y - 5, marginRight - marginLeft, 18, 2, 2, 'F');
      
      doc.setFontSize(8);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(220, 38, 38);
      doc.text('STATUS: BELUM DIBAYAR', marginLeft + 3, y + 5);
      
      y += 20;
      
      doc.setLineWidth(1.5);
      doc.setDrawColor(13, 148, 136);
      doc.line(marginLeft, y, marginRight, y);
      y += 2;
      doc.line(marginLeft, y, marginRight, y);
      
      y += 15;
      
      // ============ FOOTER ============
      doc.setFontSize(6.5);
      doc.setFont(undefined, 'italic');
      doc.setTextColor(100, 100, 100);
      doc.text('Terima kasih atas perhatian Anda', centerX, y, { align: 'center' });
      
      y += 8;
      doc.text('Simpan nota ini sebagai bukti pembayaran', centerX, y, { align: 'center' });
      
      y += 10;
      
      doc.setLineWidth(1.5);
      doc.setDrawColor(13, 148, 136);
      doc.line(marginLeft, y, marginRight, y);
      
      y += 15;
      
      const finalHeight = y + 5;
      doc.internal.pageSize.height = finalHeight;

      doc.save(`Nota_${item.id_murid}_${item.id}.pdf`);
    }

    // Filtered Data Management
    let filteredData = [];

    // Update Laporan
    function updateLaporan() {
      const total = allData.length;
      const lunas = allData.filter(item => item.status === 'lunas').length;
      const belum = total - lunas;

      document.getElementById('stat-total').textContent = total;
      document.getElementById('stat-lunas').textContent = lunas;
      document.getElementById('stat-belum').textContent = belum;

      applyFilters();
    }

    // Apply Filters
    function applyFilters() {
      const filterNama = document.getElementById('filter-nama').value.toLowerCase();
      const filterIdMurid = document.getElementById('filter-id-murid-laporan').value.toLowerCase();
      const filterStatus = document.getElementById('filter-status').value;

      filteredData = allData.filter(item => {
        const matchNama = item.nama_murid.toLowerCase().includes(filterNama);
        const matchId = item.id.toLowerCase().includes(filterIdMurid);
        const matchStatus = !filterStatus || item.status === filterStatus;
        return matchNama && matchId && matchStatus;
      });

      renderLaporanTable();
    }

    // Reset Filters
    function resetFilters() {
      document.getElementById('filter-nama').value = '';
      document.getElementById('filter-id-murid-laporan').value = '';
      document.getElementById('filter-status').value = '';
      applyFilters();
    }

    // Render Laporan Table
    function renderLaporanTable() {
      const tbody = document.getElementById('laporan-list');
      tbody.innerHTML = '';

      if (filteredData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="px-6 py-12 text-center text-gray-500"><div class="flex flex-col items-center gap-3"><svg class="w-16 h-16 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg><p class="font-semibold">Tidak ada data yang sesuai dengan filter</p></div></td></tr>';
        updateSelectedCount();
        return;
      }

      filteredData.forEach(item => {
        const row = document.createElement('tr');
        row.className = 'border-b border-gray-100 hover:bg-teal-50/50 transition-colors';
        row.dataset.itemId = item.id;
        
        const statusBadge = item.status === 'lunas'
          ? '<span class="inline-flex items-center gap-1 px-3 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-700 border border-green-200"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>Lunas</span>'
          : '<span class="inline-flex items-center gap-1 px-3 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-700 border border-red-200"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/></svg>Belum</span>';

        const tanggalBayar = item.tanggal_bayar 
          ? new Date(item.tanggal_bayar).toLocaleDateString('id-ID')
          : '-';

        row.innerHTML = `
          <td class="px-5 py-4">
            <input type="checkbox" class="row-checkbox w-4 h-4 text-teal-600 rounded focus:ring-2 focus:ring-teal-500" onchange="updateSelectedCount()">
          </td>
          <td class="px-5 py-4 font-mono text-xs text-gray-600">${item.id}</td>
          <td class="px-5 py-4 font-semibold text-gray-800">${item.nama_murid}</td>
          <td class="px-5 py-4 text-gray-700">${item.kelas}</td>
          <td class="px-5 py-4 text-gray-700">${item.nama_tagihan}</td>
          <td class="px-5 py-4 font-bold text-gray-900">Rp ${item.nominal.toLocaleString('id-ID')}</td>
          <td class="px-5 py-4">${statusBadge}</td>
          <td class="px-5 py-4 text-sm text-gray-600">${tanggalBayar}</td>
          <td class="px-5 py-4">
            <button onclick="hapusSatuData('${item.id}')" class="text-red-600 hover:text-red-700 font-semibold text-sm hover:bg-red-50 px-3 py-2 rounded-lg transition-all flex items-center gap-1">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
              </svg>
              Hapus
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });

      updateSelectedCount();
    }

    // Toggle Check All
    function toggleCheckAll() {
      const checkAll = document.getElementById('check-all');
      const checkboxes = document.querySelectorAll('.row-checkbox');
      checkboxes.forEach(cb => cb.checked = checkAll.checked);
      updateSelectedCount();
    }

    // Update Selected Count
    function updateSelectedCount() {
      const checkboxes = document.querySelectorAll('.row-checkbox:checked');
      const count = checkboxes.length;
      
      document.getElementById('count-selected').textContent = count;
      document.getElementById('count-selected-hapus').textContent = count;
      
      document.getElementById('btn-export-selected').disabled = count === 0;
      document.getElementById('btn-hapus-selected').disabled = count === 0;

      // Update check-all checkbox state
      const allCheckboxes = document.querySelectorAll('.row-checkbox');
      const checkAll = document.getElementById('check-all');
      if (allCheckboxes.length > 0) {
        checkAll.checked = allCheckboxes.length === count;
      }
    }

    // Hapus Satu Data dengan Konfirmasi
    function hapusSatuData(itemId) {
      const item = allData.find(d => d.id === itemId);
      if (!item) return;

      const overlay = document.createElement('div');
      overlay.className = 'fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4';
      overlay.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full animate-scale-in">
          <div class="bg-gradient-to-r from-red-600 to-red-500 px-6 py-5 rounded-t-2xl flex items-center gap-3">
            <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            <h3 class="text-xl font-bold text-white">Konfirmasi Hapus</h3>
          </div>
          <div class="p-6">
            <div class="mb-6">
              <div class="bg-red-50 border-l-4 border-red-500 p-5 rounded-lg mb-4">
                <p class="text-sm text-gray-700 mb-2"><span class="font-semibold">Nama:</span> ${item.nama_murid}</p>
                <p class="text-sm text-gray-700 mb-2"><span class="font-semibold">Tagihan:</span> ${item.nama_tagihan}</p>
                <p class="text-lg font-bold text-red-700 mt-3">Rp ${item.nominal.toLocaleString('id-ID')}</p>
              </div>
              <p class="text-gray-600 text-sm">Data yang dihapus tidak dapat dikembalikan. Apakah Anda yakin?</p>
            </div>
            <div class="flex gap-3">
              <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold rounded-xl transition-all flex items-center justify-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
                Batalkan
              </button>
              <button onclick="prosesHapusSatu('${itemId}'); this.closest('.fixed').remove();" class="flex-1 px-4 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-xl transition-all shadow-lg hover:shadow-xl flex items-center justify-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
                Ya, Hapus
              </button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);
    }

    function prosesHapusSatu(itemId) {
      const index = allData.findIndex(d => d.id === itemId);
      if (index !== -1) {
        allData.splice(index, 1);
        saveData();
        showCustomAlert('Data berhasil dihapus!');
      }
    }

    // Hapus Terpilih dengan Konfirmasi
    function hapusTerpilih() {
      const checkboxes = document.querySelectorAll('.row-checkbox:checked');
      if (checkboxes.length === 0) return;

      const selectedIds = [];
      checkboxes.forEach(cb => {
        const row = cb.closest('tr');
        const itemId = row.dataset.itemId;
        selectedIds.push(itemId);
      });

      const overlay = document.createElement('div');
      overlay.className = 'fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4';
      overlay.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full animate-scale-in">
          <div class="bg-gradient-to-r from-red-600 to-red-500 px-6 py-5 rounded-t-2xl flex items-center gap-3">
            <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            <h3 class="text-xl font-bold text-white">Konfirmasi Hapus</h3>
          </div>
          <div class="p-6">
            <div class="mb-6">
              <div class="bg-red-50 border-l-4 border-red-500 p-5 rounded-lg mb-4">
                <p class="text-3xl font-bold text-red-700 mb-2">${selectedIds.length} Data</p>
                <p class="text-sm text-gray-700">akan dihapus secara permanen</p>
              </div>
              <p class="text-gray-600 text-sm">Data yang dihapus tidak dapat dikembalikan. Apakah Anda yakin?</p>
            </div>
            <div class="flex gap-3">
              <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold rounded-xl transition-all flex items-center justify-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
                Batalkan
              </button>
              <button onclick="prosesHapusTerpilih(${JSON.stringify(selectedIds).replace(/"/g, '&quot;')}); this.closest('.fixed').remove();" class="flex-1 px-4 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-xl transition-all shadow-lg hover:shadow-xl flex items-center justify-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
                Ya, Hapus Semua
              </button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);
    }

    function prosesHapusTerpilih(selectedIds) {
      allData = allData.filter(item => !selectedIds.includes(item.id));
      saveData();
      showCustomAlert(`${selectedIds.length} data berhasil dihapus!`);
    }

    // Export Data ke CSV (Excel)
    function exportData() {
      if (allData.length === 0) {
        showCustomAlert('Tidak ada data untuk di-export');
        return;
      }

      exportToCSV(allData, 'Tagihan_Murid_Semua');
    }

    // Export Selected Data
    function exportSelectedData() {
      const checkboxes = document.querySelectorAll('.row-checkbox:checked');
      if (checkboxes.length === 0) {
        showCustomAlert('Pilih data yang ingin di-export terlebih dahulu');
        return;
      }

      const selectedIds = [];
      checkboxes.forEach(cb => {
        const row = cb.closest('tr');
        selectedIds.push(row.dataset.itemId);
      });

      const selectedData = allData.filter(item => selectedIds.includes(item.id));
      exportToCSV(selectedData, 'Tagihan_Murid_Terpilih');
    }

    // Export to CSV Helper
    function exportToCSV(data, filename) {
      // Header CSV
      const headers = [
        'ID Tagihan',
        'Nama Murid',
        'Kelas',
        'Jenjang',
        'Tahun Ajaran',
        'Jenis Tagihan',
        'Nama Tagihan',
        'Nominal (Rp)',
        'Status',
        'Tanggal Bayar',
        'Tanggal Input'
      ];

      // Convert data to CSV rows
      const rows = data.map(item => [
        item.id,
        item.nama_murid,
        item.kelas,
        item.jenjang,
        item.tahun_ajaran,
        item.jenis_tagihan,
        item.nama_tagihan,
        item.nominal,
        item.status === 'lunas' ? 'LUNAS' : 'BELUM BAYAR',
        item.tanggal_bayar ? new Date(item.tanggal_bayar).toLocaleDateString('id-ID') : '-',
        new Date(item.created_at).toLocaleDateString('id-ID')
      ]);

      // Combine headers and rows
      const csvContent = [
        headers.join(','),
        ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
      ].join('\n');

      // Add BOM for Excel UTF-8 support
      const BOM = '\uFEFF';
      const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = `${filename}_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
      
      URL.revokeObjectURL(url);
      showCustomAlert(`${data.length} data berhasil di-export ke CSV!`);
    }

    // Utility Functions
    function showCustomAlert(message) {
      const overlay = document.createElement('div');
      overlay.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50';
      overlay.innerHTML = `
        <div class="bg-white rounded-2xl p-6 max-w-sm mx-4 shadow-2xl animate-scale-in">
          <div class="flex items-center gap-3 mb-4">
            <svg class="w-6 h-6 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <p class="text-gray-800 font-semibold">${message}</p>
          </div>
          <button onclick="this.parentElement.parentElement.remove()" class="w-full btn-primary text-white font-semibold py-3 px-4 rounded-xl transition-all shadow-lg">
            OK
          </button>
        </div>
      `;
      document.body.appendChild(overlay);
    }

    initApp();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c0abfa0d53f98b3',t:'MTc2ODg3MjAyMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
