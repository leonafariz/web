<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Tagihan Murid</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&amp;display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    body { box-sizing: border-box; }
    * { font-family: 'Inter', sans-serif; }
    .tab-active { border-bottom: 3px solid #0d9488; color: #0d9488; font-weight: 600; }
    @media print {
      body * { visibility: hidden; }
      #print-area, #print-area * { visibility: visible; }
      #print-area { position: absolute; left: 0; top: 0; width: 100%; }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full bg-gray-50">
  <div id="app" class="w-full h-full flex flex-col overflow-hidden"><!-- Header -->
   <header class="bg-gradient-to-r from-teal-700 to-teal-600 text-white shadow-lg">
    <div class="px-6 py-4">
     <h1 id="app-title" class="text-2xl font-bold">Sistem Informasi Tagihan Murid</h1>
     <p id="school-name" class="text-teal-100 text-sm">SD Negeri 1 Contoh</p>
    </div><!-- Navigation Tabs -->
    <nav class="flex gap-1 px-6 bg-teal-800/30"><button onclick="switchTab('input')" id="tab-input" class="px-4 py-3 hover:bg-white/10 transition tab-active"> üìù Input Data </button> <button onclick="switchTab('tagihan')" id="tab-tagihan" class="px-4 py-3 hover:bg-white/10 transition"> üí≥ Tagihan Murid </button> <button onclick="switchTab('laporan')" id="tab-laporan" class="px-4 py-3 hover:bg-white/10 transition"> üìä Laporan </button>
    </nav>
   </header><!-- Main Content -->
   <main class="flex-1 overflow-auto p-6"><!-- TAB: Input Data -->
    <div id="content-input" class="tab-content">
     <div class="max-w-4xl mx-auto">
      <div class="bg-white rounded-xl shadow-md p-6 mb-6">
       <h2 class="text-xl font-bold text-gray-800 mb-4">üìã Form Input Tagihan Baru</h2>
       <form id="form-tagihan" class="space-y-4">
        <div class="grid md:grid-cols-2 gap-4">
         <div><label for="nama-murid" class="block text-sm font-medium text-gray-700 mb-1">Nama Murid</label> <input type="text" id="nama-murid" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
         </div>
         <div><label for="id-murid" class="block text-sm font-medium text-gray-700 mb-1">ID Murid</label> <input type="text" id="id-murid" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
         </div>
         <div><label for="kelas" class="block text-sm font-medium text-gray-700 mb-1">Kelas</label> <input type="text" id="kelas" required placeholder="Contoh: 1A, 2B" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
         </div>
         <div><label for="jenjang" class="block text-sm font-medium text-gray-700 mb-1">Jenjang</label> <input type="text" id="jenjang" required placeholder="Contoh: SD, SMP, SMA" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
         </div>
         <div><label for="tahun-ajaran" class="block text-sm font-medium text-gray-700 mb-1">Tahun Ajaran</label> <input type="text" id="tahun-ajaran" required placeholder="Contoh: 2024/2025" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
         </div>
         <div><label for="jenis-tagihan" class="block text-sm font-medium text-gray-700 mb-1">Jenis Tagihan</label> <select id="jenis-tagihan" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"> <option value="">-- Pilih --</option> <option value="bulanan">Bulanan (SPP)</option> <option value="bebas">Bebas (Ujian, Raport, dll)</option> </select>
         </div>
         <div><label for="nama-tagihan" class="block text-sm font-medium text-gray-700 mb-1">Nama Tagihan</label> <input type="text" id="nama-tagihan" required placeholder="Contoh: SPP Januari, Iuran Ujian" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
         </div>
         <div><label for="nominal" class="block text-sm font-medium text-gray-700 mb-1">Nominal (Rp)</label> <input type="number" id="nominal" required min="0" placeholder="100000" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
         </div>
        </div>
        <div class="flex gap-3 pt-4"><button type="submit" id="btn-submit" class="flex-1 bg-teal-600 hover:bg-teal-700 text-white font-semibold py-3 px-6 rounded-lg transition"> ‚úÖ Simpan Tagihan </button> <button type="button" onclick="resetForm()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-3 px-6 rounded-lg transition"> üîÑ Reset </button>
        </div>
       </form>
      </div><!-- Status Message -->
      <div id="status-message" class="hidden bg-green-50 border-l-4 border-green-500 p-4 rounded-lg">
       <p class="text-green-700 font-medium">‚úÖ Data berhasil disimpan!</p>
      </div>
     </div>
    </div><!-- TAB: Tagihan Murid -->
    <div id="content-tagihan" class="tab-content hidden">
     <div class="max-w-6xl mx-auto">
      <div class="bg-white rounded-xl shadow-md p-6 mb-6">
       <h2 class="text-xl font-bold text-gray-800 mb-4">üîç Cari Tagihan Murid</h2>
       <div class="flex gap-3"><input type="text" id="search-id-murid" placeholder="Masukkan ID Murid..." class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"> <button onclick="searchTagihan()" class="bg-teal-600 hover:bg-teal-700 text-white font-semibold px-6 py-3 rounded-lg transition"> üîç Cari </button>
       </div>
      </div><!-- Search Results -->
      <div id="search-results" class="hidden">
       <div class="bg-white rounded-xl shadow-md p-6 mb-6">
        <h3 class="text-lg font-bold text-gray-800 mb-3">üìå Data Murid</h3>
        <div class="grid md:grid-cols-4 gap-4 text-sm">
         <div><span class="text-gray-600">Nama:</span>
          <p id="result-nama" class="font-semibold text-gray-800">-</p>
         </div>
         <div><span class="text-gray-600">ID Murid:</span>
          <p id="result-id" class="font-semibold text-gray-800">-</p>
         </div>
         <div><span class="text-gray-600">Kelas:</span>
          <p id="result-kelas" class="font-semibold text-gray-800">-</p>
         </div>
         <div><span class="text-gray-600">Jenjang:</span>
          <p id="result-jenjang" class="font-semibold text-gray-800">-</p>
         </div>
        </div>
       </div>
       <div class="bg-white rounded-xl shadow-md p-6">
        <div class="flex justify-between items-center mb-4">
         <h3 class="text-lg font-bold text-gray-800">üí∞ Daftar Tagihan</h3><button onclick="cetakNota()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded-lg text-sm transition"> üñ®Ô∏è Cetak Nota PDF </button>
        </div>
        <div class="overflow-x-auto">
         <table class="w-full text-sm">
          <thead class="bg-gray-50 border-b-2 border-gray-200">
           <tr>
            <th class="px-4 py-3 text-left font-semibold text-gray-700">Jenis</th>
            <th class="px-4 py-3 text-left font-semibold text-gray-700">Nama Tagihan</th>
            <th class="px-4 py-3 text-left font-semibold text-gray-700">Nominal</th>
            <th class="px-4 py-3 text-left font-semibold text-gray-700">Status</th>
            <th class="px-4 py-3 text-left font-semibold text-gray-700">Aksi</th>
           </tr>
          </thead>
          <tbody id="tagihan-list"><!-- Dynamic content -->
          </tbody>
         </table>
        </div>
        <div class="mt-6 pt-4 border-t border-gray-200 flex justify-between items-center">
         <div class="text-lg font-bold text-gray-800">
          Total Belum Dibayar: <span id="total-belum-bayar" class="text-red-600">Rp 0</span>
         </div>
         <div class="text-lg font-bold text-gray-800">
          Total Sudah Dibayar: <span id="total-sudah-bayar" class="text-green-600">Rp 0</span>
         </div>
        </div>
       </div>
      </div>
      <div id="no-results" class="hidden text-center py-12">
       <div class="text-6xl mb-4">
        üîç
       </div>
       <p class="text-gray-500 text-lg">Tidak ada data untuk ID Murid tersebut</p>
      </div>
     </div>
    </div><!-- TAB: Laporan -->
    <div id="content-laporan" class="tab-content hidden">
     <div class="max-w-6xl mx-auto">
      <div class="bg-white rounded-xl shadow-md p-6 mb-6">
       <h2 class="text-xl font-bold text-gray-800 mb-4">üìä Laporan Tagihan</h2>
       <div class="grid md:grid-cols-3 gap-4 mb-6">
        <div class="bg-blue-50 rounded-lg p-4">
         <p class="text-blue-600 text-sm font-medium mb-1">Total Tagihan</p>
         <p id="stat-total" class="text-2xl font-bold text-blue-700">0</p>
        </div>
        <div class="bg-green-50 rounded-lg p-4">
         <p class="text-green-600 text-sm font-medium mb-1">Sudah Dibayar</p>
         <p id="stat-lunas" class="text-2xl font-bold text-green-700">0</p>
        </div>
        <div class="bg-red-50 rounded-lg p-4">
         <p class="text-red-600 text-sm font-medium mb-1">Belum Dibayar</p>
         <p id="stat-belum" class="text-2xl font-bold text-red-700">0</p>
        </div>
       </div><button onclick="exportData()" class="bg-green-600 hover:bg-green-700 text-white font-semibold px-6 py-3 rounded-lg transition mb-4"> üì• Export Data JSON </button>
       <div class="overflow-x-auto">
        <table class="w-full text-sm">
         <thead class="bg-gray-50 border-b-2 border-gray-200">
          <tr>
           <th class="px-4 py-3 text-left font-semibold text-gray-700">ID Murid</th>
           <th class="px-4 py-3 text-left font-semibold text-gray-700">Nama</th>
           <th class="px-4 py-3 text-left font-semibold text-gray-700">Kelas</th>
           <th class="px-4 py-3 text-left font-semibold text-gray-700">Tagihan</th>
           <th class="px-4 py-3 text-left font-semibold text-gray-700">Nominal</th>
           <th class="px-4 py-3 text-left font-semibold text-gray-700">Status</th>
           <th class="px-4 py-3 text-left font-semibold text-gray-700">Tanggal Bayar</th>
          </tr>
         </thead>
         <tbody id="laporan-list"><!-- Dynamic content -->
         </tbody>
        </table>
       </div>
      </div>
     </div>
    </div>
   </main><!-- Loading Overlay -->
   <div id="loading-overlay" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 flex items-center gap-3">
     <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-teal-600"></div><span class="font-medium text-gray-700">Memproses...</span>
    </div>
   </div>
  </div>
  <script>
    const defaultConfig = {
      app_title: 'Sistem Informasi Tagihan Murid',
      school_name: 'SD Negeri 1 Contoh',
      school_address: 'Jl. Pendidikan No. 123',
      primary_color: '#0f766e',
      secondary_color: '#f8fafc',
      text_color: '#1f2937',
      accent_color: '#0d9488',
      button_color: '#2563eb',
      font_family: 'Inter',
      font_size: 16
    };

    let config = { ...defaultConfig };
    let allData = [];
    let currentSearchData = null;

    // Data SDK Handler
    const dataHandler = {
      onDataChanged(data) {
        allData = data;
        updateLaporan();
        
        if (currentSearchData) {
          const idMurid = document.getElementById('search-id-murid').value.trim();
          if (idMurid) {
            renderSearchResults(idMurid);
          }
        }
      }
    };

    // Initialize SDKs
    async function initApp() {
      if (window.dataSdk) {
        const result = await window.dataSdk.init(dataHandler);
        if (!result.isOk) {
          console.error('Failed to initialize data SDK');
        }
      }

      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange,
          mapToCapabilities,
          mapToEditPanelValues
        });
      }
    }

    async function onConfigChange(cfg) {
      config = { ...defaultConfig, ...cfg };
      
      document.getElementById('app-title').textContent = config.app_title || defaultConfig.app_title;
      document.getElementById('school-name').textContent = config.school_name || defaultConfig.school_name;
      
      const customFont = config.font_family || defaultConfig.font_family;
      document.body.style.fontFamily = `${customFont}, sans-serif`;
      
      const baseSize = config.font_size || defaultConfig.font_size;
      document.documentElement.style.fontSize = `${baseSize}px`;
    }

    function mapToCapabilities(cfg) {
      return {
        recolorables: [
          {
            get: () => cfg.primary_color || defaultConfig.primary_color,
            set: (value) => { cfg.primary_color = value; if (window.elementSdk) window.elementSdk.setConfig({ primary_color: value }); }
          },
          {
            get: () => cfg.secondary_color || defaultConfig.secondary_color,
            set: (value) => { cfg.secondary_color = value; if (window.elementSdk) window.elementSdk.setConfig({ secondary_color: value }); }
          },
          {
            get: () => cfg.text_color || defaultConfig.text_color,
            set: (value) => { cfg.text_color = value; if (window.elementSdk) window.elementSdk.setConfig({ text_color: value }); }
          },
          {
            get: () => cfg.accent_color || defaultConfig.accent_color,
            set: (value) => { cfg.accent_color = value; if (window.elementSdk) window.elementSdk.setConfig({ accent_color: value }); }
          },
          {
            get: () => cfg.button_color || defaultConfig.button_color,
            set: (value) => { cfg.button_color = value; if (window.elementSdk) window.elementSdk.setConfig({ button_color: value }); }
          }
        ],
        borderables: [],
        fontEditable: {
          get: () => cfg.font_family || defaultConfig.font_family,
          set: (value) => { cfg.font_family = value; if (window.elementSdk) window.elementSdk.setConfig({ font_family: value }); }
        },
        fontSizeable: {
          get: () => cfg.font_size || defaultConfig.font_size,
          set: (value) => { cfg.font_size = value; if (window.elementSdk) window.elementSdk.setConfig({ font_size: value }); }
        }
      };
    }

    function mapToEditPanelValues(cfg) {
      return new Map([
        ['app_title', cfg.app_title || defaultConfig.app_title],
        ['school_name', cfg.school_name || defaultConfig.school_name],
        ['school_address', cfg.school_address || defaultConfig.school_address]
      ]);
    }

    // Tab Navigation
    function switchTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
      document.querySelectorAll('nav button').forEach(el => el.classList.remove('tab-active'));
      
      document.getElementById(`content-${tabName}`).classList.remove('hidden');
      document.getElementById(`tab-${tabName}`).classList.add('tab-active');
    }

    // Form Submission
    document.getElementById('form-tagihan').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (allData.length >= 999) {
        showCustomAlert('Batas maksimum 999 data tercapai. Hapus beberapa data terlebih dahulu.');
        return;
      }

      const formData = {
        id: Date.now().toString(),
        type: 'tagihan',
        nama_murid: document.getElementById('nama-murid').value,
        id_murid: document.getElementById('id-murid').value,
        kelas: document.getElementById('kelas').value,
        jenjang: document.getElementById('jenjang').value,
        tahun_ajaran: document.getElementById('tahun-ajaran').value,
        jenis_tagihan: document.getElementById('jenis-tagihan').value,
        nama_tagihan: document.getElementById('nama-tagihan').value,
        nominal: parseFloat(document.getElementById('nominal').value),
        status: 'belum_bayar',
        tanggal_bayar: '',
        created_at: new Date().toISOString()
      };

      showLoading(true);
      const result = await window.dataSdk.create(formData);
      showLoading(false);

      if (result.isOk) {
        showStatusMessage();
        resetForm();
      } else {
        showCustomAlert('Gagal menyimpan data. Silakan coba lagi.');
      }
    });

    function resetForm() {
      document.getElementById('form-tagihan').reset();
    }

    function showStatusMessage() {
      const msg = document.getElementById('status-message');
      msg.classList.remove('hidden');
      setTimeout(() => msg.classList.add('hidden'), 3000);
    }

    // Search Tagihan
    function searchTagihan() {
      const idMurid = document.getElementById('search-id-murid').value.trim();
      if (!idMurid) {
        showCustomAlert('Masukkan ID Murid terlebih dahulu');
        return;
      }

      renderSearchResults(idMurid);
    }

    function renderSearchResults(idMurid) {
      const filtered = allData.filter(item => item.id_murid === idMurid);
      
      if (filtered.length === 0) {
        document.getElementById('search-results').classList.add('hidden');
        document.getElementById('no-results').classList.remove('hidden');
        currentSearchData = null;
        return;
      }

      currentSearchData = filtered;
      document.getElementById('no-results').classList.add('hidden');
      document.getElementById('search-results').classList.remove('hidden');

      const first = filtered[0];
      document.getElementById('result-nama').textContent = first.nama_murid;
      document.getElementById('result-id').textContent = first.id_murid;
      document.getElementById('result-kelas').textContent = first.kelas;
      document.getElementById('result-jenjang').textContent = first.jenjang;

      const tbody = document.getElementById('tagihan-list');
      tbody.innerHTML = '';

      let totalBelum = 0;
      let totalSudah = 0;

      filtered.forEach(item => {
        const row = document.createElement('tr');
        row.className = 'border-b border-gray-100 hover:bg-gray-50';
        
        const badgeClass = item.jenis_tagihan === 'bulanan' 
          ? 'bg-blue-100 text-blue-700' 
          : 'bg-purple-100 text-purple-700';
        
        const statusBadge = item.status === 'lunas'
          ? '<span class="inline-block px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-700">‚úÖ Lunas</span>'
          : '<span class="inline-block px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-700">‚è≥ Belum Bayar</span>';

        const actionBtn = item.status === 'lunas'
          ? '<button disabled class="px-3 py-1 text-xs bg-gray-200 text-gray-500 rounded cursor-not-allowed">Sudah Dibayar</button>'
          : `<button onclick="konfirmasiBayar('${item.__backendId}')" class="px-3 py-1 text-xs bg-teal-600 hover:bg-teal-700 text-white rounded transition font-semibold">üí∞ Bayar</button>`;

        if (item.status === 'lunas') {
          totalSudah += item.nominal;
        } else {
          totalBelum += item.nominal;
        }

        row.innerHTML = `
          <td class="px-4 py-3">
            <span class="inline-block px-2 py-1 text-xs font-semibold rounded-full ${badgeClass}">
              ${item.jenis_tagihan}
            </span>
          </td>
          <td class="px-4 py-3 font-medium text-gray-800">${item.nama_tagihan}</td>
          <td class="px-4 py-3 font-semibold text-gray-900">Rp ${item.nominal.toLocaleString('id-ID')}</td>
          <td class="px-4 py-3">${statusBadge}</td>
          <td class="px-4 py-3">${actionBtn}</td>
        `;
        tbody.appendChild(row);
      });

      document.getElementById('total-belum-bayar').textContent = 'Rp ' + totalBelum.toLocaleString('id-ID');
      document.getElementById('total-sudah-bayar').textContent = 'Rp ' + totalSudah.toLocaleString('id-ID');
    }

    async function konfirmasiBayar(backendId) {
      const item = allData.find(d => d.__backendId === backendId);
      if (!item) return;

      const confirmed = await showCustomConfirm(`Konfirmasi pembayaran ${item.nama_tagihan} sebesar Rp ${item.nominal.toLocaleString('id-ID')}?`);
      if (!confirmed) return;

      const updatedItem = {
        ...item,
        status: 'lunas',
        tanggal_bayar: new Date().toISOString()
      };

      showLoading(true);
      const result = await window.dataSdk.update(updatedItem);
      showLoading(false);

      if (result.isOk) {
        showCustomAlert('‚úÖ Pembayaran berhasil dikonfirmasi!');
      } else {
        showCustomAlert('‚ùå Gagal mengkonfirmasi pembayaran. Silakan coba lagi.');
      }
    }

    // Cetak Nota PDF
    function cetakNota() {
      if (!currentSearchData || currentSearchData.length === 0) return;

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const first = currentSearchData[0];
      const schoolName = config.school_name || defaultConfig.school_name;
      const schoolAddress = config.school_address || defaultConfig.school_address;

      doc.setFontSize(16);
      doc.setFont(undefined, 'bold');
      doc.text(schoolName, 105, 20, { align: 'center' });
      
      doc.setFontSize(10);
      doc.setFont(undefined, 'normal');
      doc.text(schoolAddress, 105, 27, { align: 'center' });
      
      doc.setLineWidth(0.5);
      doc.line(20, 32, 190, 32);

      doc.setFontSize(14);
      doc.setFont(undefined, 'bold');
      doc.text('NOTA TAGIHAN', 105, 42, { align: 'center' });

      doc.setFontSize(10);
      doc.setFont(undefined, 'normal');
      const tanggal = new Date().toLocaleDateString('id-ID', { 
        day: 'numeric', 
        month: 'long', 
        year: 'numeric' 
      });
      doc.text(`Tanggal: ${tanggal}`, 20, 52);

      doc.setFont(undefined, 'bold');
      doc.text('Data Murid:', 20, 62);
      doc.setFont(undefined, 'normal');
      doc.text(`Nama: ${first.nama_murid}`, 20, 69);
      doc.text(`ID Murid: ${first.id_murid}`, 20, 76);
      doc.text(`Kelas: ${first.kelas}`, 20, 83);
      doc.text(`Jenjang: ${first.jenjang}`, 20, 90);

      doc.setFont(undefined, 'bold');
      doc.text('Daftar Tagihan:', 20, 102);

      let yPos = 110;
      let totalBelum = 0;
      let totalLunas = 0;

      currentSearchData.forEach((item, idx) => {
        const status = item.status === 'lunas' ? '‚úì Lunas' : '‚úó Belum';
        const nominal = item.nominal.toLocaleString('id-ID');
        
        doc.setFont(undefined, 'normal');
        doc.text(`${idx + 1}. ${item.nama_tagihan}`, 25, yPos);
        doc.text(`Rp ${nominal}`, 120, yPos);
        doc.text(status, 170, yPos);
        
        if (item.status === 'lunas') {
          totalLunas += item.nominal;
        } else {
          totalBelum += item.nominal;
        }
        
        yPos += 7;
      });

      yPos += 5;
      doc.setLineWidth(0.3);
      doc.line(20, yPos, 190, yPos);
      
      yPos += 7;
      doc.setFont(undefined, 'bold');
      doc.text('Total Belum Dibayar:', 25, yPos);
      doc.text(`Rp ${totalBelum.toLocaleString('id-ID')}`, 120, yPos);
      
      yPos += 7;
      doc.text('Total Sudah Dibayar:', 25, yPos);
      doc.text(`Rp ${totalLunas.toLocaleString('id-ID')}`, 120, yPos);

      yPos += 15;
      doc.setFontSize(9);
      doc.setFont(undefined, 'italic');
      doc.text('Dokumen ini dicetak oleh sistem. Simpan sebagai bukti pembayaran.', 105, yPos, { align: 'center' });

      doc.save(`Nota_${first.id_murid}_${Date.now()}.pdf`);
    }

    // Update Laporan
    function updateLaporan() {
      const total = allData.length;
      const lunas = allData.filter(item => item.status === 'lunas').length;
      const belum = total - lunas;

      document.getElementById('stat-total').textContent = total;
      document.getElementById('stat-lunas').textContent = lunas;
      document.getElementById('stat-belum').textContent = belum;

      const tbody = document.getElementById('laporan-list');
      tbody.innerHTML = '';

      allData.forEach(item => {
        const row = document.createElement('tr');
        row.className = 'border-b border-gray-100 hover:bg-gray-50';
        
        const statusBadge = item.status === 'lunas'
          ? '<span class="inline-block px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-700">Lunas</span>'
          : '<span class="inline-block px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-700">Belum</span>';

        const tanggalBayar = item.tanggal_bayar 
          ? new Date(item.tanggal_bayar).toLocaleDateString('id-ID')
          : '-';

        row.innerHTML = `
          <td class="px-4 py-3 font-mono text-sm">${item.id_murid}</td>
          <td class="px-4 py-3 font-medium">${item.nama_murid}</td>
          <td class="px-4 py-3">${item.kelas}</td>
          <td class="px-4 py-3">${item.nama_tagihan}</td>
          <td class="px-4 py-3 font-semibold">Rp ${item.nominal.toLocaleString('id-ID')}</td>
          <td class="px-4 py-3">${statusBadge}</td>
          <td class="px-4 py-3 text-sm">${tanggalBayar}</td>
        `;
        tbody.appendChild(row);
      });
    }

    // Export Data
    function exportData() {
      const dataStr = JSON.stringify(allData, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `data_tagihan_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      URL.revokeObjectURL(url);
    }

    // Utility Functions
    function showLoading(show) {
      document.getElementById('loading-overlay').classList.toggle('hidden', !show);
    }

    function showCustomAlert(message) {
      const overlay = document.createElement('div');
      overlay.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
      overlay.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-sm mx-4 shadow-xl">
          <p class="text-gray-800 mb-4">${message}</p>
          <button onclick="this.parentElement.parentElement.remove()" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2 px-4 rounded-lg transition">
            OK
          </button>
        </div>
      `;
      document.body.appendChild(overlay);
    }

    function showCustomConfirm(message) {
      return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
        overlay.innerHTML = `
          <div class="bg-white rounded-lg p-6 max-w-sm mx-4 shadow-xl">
            <p class="text-gray-800 mb-4">${message}</p>
            <div class="flex gap-3">
              <button id="confirm-no" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg transition">
                Batal
              </button>
              <button id="confirm-yes" class="flex-1 bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2 px-4 rounded-lg transition">
                Ya
              </button>
            </div>
          </div>
        `;
        document.body.appendChild(overlay);
        
        overlay.querySelector('#confirm-yes').onclick = () => {
          overlay.remove();
          resolve(true);
        };
        overlay.querySelector('#confirm-no').onclick = () => {
          overlay.remove();
          resolve(false);
        };
      });
    }

    initApp();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c04edc2d665fba0',t:'MTc2ODgxMDk5My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
